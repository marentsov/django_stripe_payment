<!-- templates/checkout.html -->
{% extends 'base.html' %}
{% block title %}Оплата{% endblock %}
{% block content %}
    <h1>Оплата заказа #{{ order.id }}</h1>
    <div id="card-element"></div>
    <button id="submit">Оплатить</button>
    <div id="error-message"></div>

    <script>
        var stripe = Stripe('{{ stripe_publishable_key }}');
        var elements = stripe.elements();
        var card = elements.create('card');
        card.mount('#card-element');

        document.getElementById('submit').addEventListener('click', async () => {
            const response = await fetch('{% url 'store:create_payment_intent' pk=order.id %}', { method: 'GET' });
            const data = await response.json();
            if (data.error) {
                document.getElementById('error-message').textContent = data.error;
                return;
            }
            const result = await stripe.confirmCardPayment(data.client_secret, {
                payment_method: { card: card }
            });
            if (result.error) {
                document.getElementById('error-message').textContent = result.error.message;
            } else {
                window.location.href = '/success/';
            }
        });
    </script>
{% endblock %}